---
layout: post
title: Turbulence ahead - fasten your seatbelt
date: '2018-08-24T18:22:00.002+01:00'
author: Tinkerer
tags:
- security
- proxy
- home assistant
modified_time: '2018-11-10T18:00:20.832Z'
---

With 0.77 it looks like the new Home Assistant authentication platform will be mandatory. For almost everybody it'll be a <i>meh</i>&nbsp;moment - ensure the legacy auth is enabled, and you're done.<br /><br />For those of us who moved to doing authentication in a proxy server, because a single password for <b>everything</b>&nbsp;scared us, this is going to require some change.<br /><h3>Take a deep breath</h3><div>You'll need to enable the legacy auth, and then configure your proxy to set the required header. This requires the addition of... <i>a single line</i>&nbsp;to your proxy configuration. Ok, two lines if you're using Apache.<br /><br /><b>NB:</b>&nbsp;I've updated this to use the new <i>Long Lived Access Token</i><b style="font-style: italic;">&nbsp;</b>that you create in your user profile.<br /><br />Yes, the change here is minor, trivial almost. If you enable the new authentication then you'll have the option of using that or the API password to log in to the front end regardless of what you do here. The header we're adding only seems to be used by the API.</div><div><br />I've tested the following on my development system, using NGINX. I don't run the others, but I've checked the documentation for each of them so this should be correct.</div><h4>NGINX</h4><div>On NGINX you add the following to the <kbd>location</kbd> section(s) of your configuration:</div><div><pre>proxy_set_header proxy_set_header Authorization "Bearer YOUR_LONG_LIVED_ACCESS_TOKEN";</pre><h3>Caddy</h3><div>On Caddy you add the following to the <kbd>proxy</kbd> section(s) of your configuration:</div><div><pre>header_upstream Authorization "Bearer YOUR_LONG_LIVED_ACCESS_TOKEN"</pre></div>Alternatively, you can do the same in the <kbd>header</kbd> section if you want it for every page:<br /><pre>Authorization "Bearer YOUR_LONG_LIVED_ACCESS_TOKEN";</pre><h3>HAProxy</h3><div>On HA Proxy you add the following to the <kbd>backend</kbd> section(s) of your configuration:</div><div><pre>http-request add-header Authorization "Bearer YOUR_LONG_LIVED_ACCESS_TOKEN"</pre></div><h3>Apache</h3><div>On Apache Proxy you add the following to the <kbd>LocationMatch</kbd> section(s) of your configuration:</div><div><pre>Header add Authorization "Bearer YOUR_LONG_LIVED_ACCESS_TOKEN"<br />RequestHeader set Authorization "Bearer YOUR_LONG_LIVED_ACCESS_TOKEN"</pre></div><h3>Going forwards?</h3><div>It doesn't look like Home Assistant's auth system will support Basic authentication, which would appear convenient. Instead the developers are discussing effectively embedding authentication tokens in the URLs for external services. That'll probably be even easier to adapt to though<br /><br />At that point I'll probably switch from NGINX to HA Proxy. Nothing I'm doing really needs NGINX, and HA Proxy should be faster given I'm running all of this on a Pi.</div></div>