---
layout: post
title: Backing up Home Assistant
date: '2017-10-23T22:49:00.002+01:00'
author: Tinkerer
tags:
- backup
- home assistant
modified_time: '2022-04-09T21:30:45.839+01:00'
---

It was suggested on the <a href="https://home-assistant.io/">Home Assistant</a> Discord channel that I write a simple step by step for backing up your Home Assistant configuration.<br /><br />Now, before I begin, I will say <b>RAID IS NOT BACKUP</b>. RAID protects you from hardware failure, at most. You'll need file systems like ZFS or BTRFS to protect you against corrupt files though.<br /><br />My suggestion is to use a bootable backup (courtesy of <a href="https://github.com/billw2/rpi-clone">rpi-clone</a>), a local backup, and an online backup. Nobody has ever regretted having too many backups (well, outside of situations when they find themselves in court).<div><h2 style="text-align: left;">Software summary</h2><div>For those referred here, this is a summary of the backup software I recommend. You can read further for how I use them (not all are documented here since this is an older article):</div><div><ul style="text-align: left;"><li><a href="https://github.com/billw2/rpi-clone" target="_blank">rpi-clone</a> - Live SD card images for Pi's running something other than HAOS</li><li><a href="https://rsnapshot.org/" target="_blank">rsnapshot</a> - Local network backups using rsync (third party Docker images <a href="https://hub.docker.com/search?q=rsnapshot&amp;type=image" target="_blank">are available</a>)</li><li><a href="https://rclone.org/" target="_blank">rclone</a> - Local or remote backups, which can be encrypted (<a href="https://hub.docker.com/r/rclone/rclone" target="_blank">official Docker image</a>)</li><li><a href="https://kopia.io/" target="_blank">kopia</a>&nbsp;- Encrypted local or remote backups (<a href="https://kopia.io/docs/installation/#docker-images" target="_blank">official Docker image</a>)&nbsp;</li></ul></div><h2>Local backups</h2><div>As well as <a href="https://github.com/billw2/rpi-clone">rpi-clone</a> for bootable snapshots, there's 2 different approaches you can use to back up Home Assistant within your home network: directly on the computer running Home Assistant, or from another computer. The second is a better option, but I'll also document the first for completeness. In both cases, I'll be using <a href="http://rsnapshot.org/">rsnapshot</a>, a fantastic utility that uses rsync. If you haven't already installed, it, do so now (<kbd>sudo apt-get install rsnapshot</kbd>) and then come back.<br /><br />Why do I think the second option is better? If something bad happens to your Pi (whether a catastrophic failure, by typing <kbd>rm -fr /</kbd>&nbsp;in error, or a hack) then the odds of it impacting the second system are lower.</div><h3>On the same computer</h3><div>Connect a USB disk, whether a thumb drive, an SDD, or a traditional hard disk. I'd suggest mounting it on <kbd>/backup</kbd>, that makes it very clear what the purpose is. Follow the same process as <a href="https://sgrudadh.blogspot.co.uk/2017/10/home-assistant-moving-logs-and-database.html">explained here</a>, except you create a single partition from <kbd>2048s</kbd> to <kbd>100%</kbd>.<br /><br />Now create a sub-folder called snapshots:<br /><blockquote class="tr_bq"><kbd>$ sudo mkdir /backup/snapshots</kbd></blockquote>Some key things for your <kbd>/etc/rsnapshot.conf</kbd> (use TAB, not spaces to separate the fields):<br /><blockquote class="tr_bq"><pre>snapshot_root&nbsp; &nbsp; /backup/snapshots<br />no_create_root&nbsp; &nbsp;1<br />one_fs&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1<br /><br />exclude&nbsp; &nbsp;home-assistant_v2.db<br />exclude&nbsp; &nbsp;OZW_Log.txt<br />exclude&nbsp; &nbsp;home-assistant.log<br /><br />backup&nbsp; &nbsp; /home/homeassistant&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localhost/</pre></blockquote></div><div>If your Home Assistant install is elsewhere, replace <kbd>/home/homeassistant</kbd> accordingly. Now you just need to update <kbd>/etc/cron.d/rsnapshot</kbd>, remove the <kbd>#</kbd> characters from the last 4 lines, so that it reads<br /><blockquote class="tr_bq"><pre>0 */4    * * *    root    /usr/bin/rsnapshot alpha<br />30 3    * * *    root    /usr/bin/rsnapshot beta<br />0 3   * * 1    root    /usr/bin/rsnapshot gamma<br />30 2    1 * *    root    /usr/bin/rsnapshot delta</pre></blockquote>If you're using <kbd>sync_first 1</kbd> then instead it must look like: <br /><blockquote class="tr_bq"><pre>0 */4    * * *    root    /usr/bin/rsnapshot sync &amp;&amp; /usr/bin/rsnapshot alpha<br />30 3    * * *    root    /usr/bin/rsnapshot beta<br />0 3   * * 1    root    /usr/bin/rsnapshot gamma<br />30 2    1 * *    root    /usr/bin/rsnapshot delta</pre></blockquote></div><div>The names at the end of those lines should match up with the&nbsp;<kbd>retain</kbd>&nbsp;lines in your&nbsp;<span style="font-family: monospace;">/etc/rsnapshot.conf</span>&nbsp;(you may have to uncomment the fourth line). Older versions of the default configuration file may use&nbsp;<span style="font-family: monospace;">hourly</span>,&nbsp;<span style="font-family: monospace;">daily</span>,&nbsp;<span style="font-family: monospace;">weekly</span>, etc.<br /><h3>On a remote computer</h3>It's very similar to the above, the only difference is that the backup line will read:<br /><div style="-webkit-text-stroke-width: 0px; color: black; font-family: &quot;Times New Roman&quot;; font-size: medium; font-style: normal; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: start; text-decoration-color: initial; text-decoration-style: initial; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px;"><blockquote class="tr_bq"><pre style="margin: 0px;">backup&nbsp; root@192.168.0.10:/home/homeassistant&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 192.168.0.10/</pre></blockquote></div></div><div>Replace <kbd>192.168.0.10</kbd> with the LAN IP of your Home Assistant server. You'll also need to create an SSH key, with no passphrase, for rsnapshot to use, then copy it over. On the remote computer, the one running rsnapshot, run:<br /><blockquote class="tr_bq"><kbd>$ sudo ssh-keygen -t&nbsp;ed25519</kbd></blockquote>When asked for a passphrase, hit enter. This will create two files <kbd>/root/.ssh/id_ed25519</kbd> and <kbd>/root/.ssh/id_ed25519.pub</kbd>. The second of those you'll need to copy across to your Home Assistant server, and place in <kbd>/root/.ssh/authorized_keys:</kbd><br /><blockquote class="tr_bq"><kbd>$ sudo scp /root/.ssh/id_ed25519.pub pi@192.168.0.10:</kbd></blockquote>Now ssh to the Home Assistant server and run:<br /><blockquote class="tr_bq"><kbd>$ sudo cp ~pi/id_ed25519.pub /root/.ssh/authorized_keys</kbd></blockquote>Finally, back to the other system, and run:<br /><blockquote class="tr_bq"><kbd>$ sudo ssh root@192.168.0.10</kbd></blockquote>You should be prompted accept the SSH key for the remote system, and then you'll be all set.<br /><br />If that doesn't work, it's because the settings of <kbd>PermitRootLogin</kbd> isn't right. Edit <kbd>/etc/ssh/sshd_config</kbd> with your favourite editor (you'll likely need to use <kbd>sudo</kbd>)and update that line to read:<br /><pre>PermitRootLogin without-password<br /></pre>Then tell it to re-read the configuration with:<br /><pre>$ sudo pkill -HUP sshd<br /></pre><h2>Online backups</h2></div>Local backups are all very good, but online backups allow you to recover even if you suffer a catastrophic failure (theft, fire, falling bows of petunias...).<br /><h3>rclone</h3><div><a href="https://rclone.org/">rclone</a> describes itself as a program to sync files and directories (with a long list of providers), but a number of those support versioning (including Backblaze B2 and Google Drive), giving you a true backup solution. It even supports <a href="https://rclone.org/crypt/">encrypting</a> your files before uploading, and I would <i>highly recommend&nbsp;</i>that you use that. Your Home Assistant configuration likely contains many <a href="https://home-assistant.io/docs/configuration/secrets/">secrets</a> after all.</div><div><br /></div><div>The rclone documentation does a great job of covering how to set it up, so I won't bother covering that in detail. I created an encrypted Backblaze B2 service called <kbd>BB2</kbd>, and I'm using a bucket called <kbd>HA</kbd>. Remember to keep a separate note of the passwords you set if you use encryption, somewhere not on the Pi you're backing up.</div><div><br /></div><div>I've also created a file in a directory <kbd>/local</kbd>, called <kbd>b2-excludes</kbd>. This has a number of things I don't want backed up online:</div><div><blockquote class="tr_bq"><pre>.bash_history/<br />.lesshst<br />.ssh/<br />.cache/<br />tmp/<br />*.core<br />home-assistant_v2.db<br />OZW_Log.txt<br />home-assistant.log<br />.google.token</pre></blockquote></div><div>I run the following from cron every 2 hours:</div><div><pre>/usr/local/bin/rclone --transfers 2 --bwlimit 5M --exclude-from /local/b2-excludes sync /home/homeassistant BB2:HA</pre></div>I limit it to 2 parallel operations, and 5 Mb/s as this is sufficient, and avoids making my upload too busy (if it interferes with online gaming, I get to hear about in <i>very</i>&nbsp;short order). You should test different values to find what works for you.<br /><h3>Github</h3><div>Github also gives you versioning, but you absolutely must ensure you don't back up any secrets. The <a href="https://home-assistant.io/docs/ecosystem/backup/backup_github/">Home Assistant documentation</a> covers how you can do this.</div><h2>Before you go</h2><div>Remember, a backup you can't recover from is worthless. Test that you can recover from <i>all</i>&nbsp;the locations you back up to periodically.</div></div>