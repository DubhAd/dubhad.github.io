---
layout: post
title: Upgrading the Python Virtual Environment
date: '2017-12-08T11:45:00.034Z'
author: Tinkerer
tags:
- venv
- python
- home assistant
modified_time: '2022-05-03T09:48:58.013+01:00'
---

<div class="warning">Unless you're running local other software directly from the venv, consider <a href="{{ site.baseurl }}{% post_url 2020-10-10-ha-venv-to-docker %}">switching to Docker</a>. It'll save you from ever needing to upgrade Python and rebuild the venv again. </div> <div class="info"><strong>Updates</strong><ul style="text-align: left;">  <li><strong>October 2020</strong> for Python 3.7 deprecation, and to add libraries for Pillow&nbsp;</li><li><strong>July 2020 </strong>based on <a href="https://github.com/home-assistant/docker-base/pull/82" rel="nofollow" target="_blank">this change</a> to the official HA Docker container</li><li><strong>December 2019</strong> to account for the deprecation of Python 3.6 support</li></ul></div> <p>You may also want to look at <a href="https://github.com/pyenv/pyenv-installer">pyenv-installer</a> as another way of installing and using Python virtual environments, with multiple versions of Python.</p> With the deprecation of Python <strike>3.4</strike> <strike>3.5</strike> <strike>3.6</strike> 3.7 support, people have been wondering how to upgrade their Python venv. There's a <a href="https://community.home-assistant.io/t/python-3-6-upgrade-of-a-virtualenv/21722">forum thread</a>&nbsp;and a related <a href="https://raspberrypi.stackexchange.com/questions/54365/how-to-download-and-install-python-3-5-in-raspbian/56632#56632">StackExchange answer</a> on the subject, but here's my experience. I'm upgrading the All in One installer here, so my virtual environment was in <kbd>/srv/homeassistant/homeassistant_venv/</kbd><br /><h3>Install Python 3.x</h3><div class="warning"><strong>Do not</strong> install Beta or Alpha versions of Python. These are marked by the letter <code>a</code> or <code>b</code> in the version number, for example <code>3.9.0<span style="color: red;"><strong>a</strong></span>4</code>. These are unfinished versions, and using them will cause you problems. </div><div class="info">If you want to take a shortcut, I've a <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/local/bin/build_python">script</a> that you can use to install all the pre-requisites, compile and install Python, and create and prepare the venv.<br /><br />Download the script, make it executable, and then run it with the version of Python you want to use. For example: <kbd>./build_python 3.9.7</kbd></div><div>We're going to cover Python 3.9.7 now that Python 3.9 is supported by HA Core and I've updated this article accordingly since I know it works as expected.</div><div>First, prepare the system - this now includes support for <kbd>jemalloc</kbd> and <kbd>cargo</kbd> (required for the latest version of the <kbd>cryptography</kbd> package):</div><div><pre>sudo apt install build-essential tk-dev libncurses5-dev libncursesw5-dev libreadline-dev \<br />  libdb5.3-dev libgdbm-dev libsqlite3-dev libssl-dev libbz2-dev libexpat1-dev liblzma-dev \<br />  zlib1g-dev libudev-dev unixodbc-dev libpq-dev libwebp-dev libopenjp2-7-dev libjpeg-dev \<br />  libtiff5-dev libfreetype6-dev libc-dev libffi-dev libbluetooth-dev libtirpc-dev libjemalloc-dev cargo<br />sudo ldconfig</pre></div><div>Now download and install Python 3.9.7 (if a later version is out, you can use that, just change 3.9.7 to your version number). I have a USB thumb drive on <kbd>/data</kbd>, that I used for this (to move all the I/O off the SD card). Note that <kbd>make install</kbd> will replace your <kbd>python3</kbd> link with one for this version of python (your old version of python will still be accessible). You likely don't want that, so here we use <kbd>make altinstall</kbd> instead.</div><div><pre>cd /data<br />wget https://www.python.org/ftp/python/3.9.7/Python-3.9.7.tgz<br />tar -zxvf Python-3.9.7.tgz<br />cd Python-3.9.7<br />./configure --enable-optimizations --enable-shared --with-lto --with-system-expat \<br />  --with-system-ffi --without-ensurepip<br />make -j$(cat /proc/cpuinfo|egrep -c "^processor") \<br />  LDFLAGS="-Wl,--strip-all" \<br />  CFLAGS="-fno-semantic-interposition -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free -ljemalloc" \<br />  EXTRA_CFLAGS="-DTHREAD_STACK_SIZE=0x100000"<br />sudo make altinstall</pre></div>The make command will take a little over an hour on a Pi3, and considerably less on more capable systems.<div><h4 style="text-align: left;">Crashes</h4>Somebody has reported that on older Debian installs the <kbd>make</kbd> step fails with segmentation faults, and the needed to run the following commands first. I haven't seen that, but if it happens, try it.<br /><pre>sudo apt-get install libtcmalloc-minimal4<br />export LD_PRELOAD="/usr/lib/libtcmalloc_minimal.so.4"</pre>I've seen the same on Raspbian Buster, where I needed to do: <pre>sudo apt-get install libtcmalloc-minimal4<br />export LD_PRELOAD="/usr/lib/arm-linux-gnueabihf/libtcmalloc_minimal.so.4.5.3"</pre><div style="text-align: left;">In both cases, that means removing <kbd>CFLAGS</kbd> line above from your make.</div><h3>Create the new virtual environment</h3>Make the new environment using the user you run Home Assistant as (this assumes you're using <kbd>homeassistant</kbd>. I put mine in separate folders so I can do upgrades without impacting my live install. <br /><div><pre>sudo mkdir /srv/homeassistant<br />sudo chown homeassistant:homeassistant /srv/homeassistant<br />sudo -u homeassistant -H -s<br />python3.9 -m venv /srv/homeassistant/venv_3.9.7</pre></div><h3>Prepare the new virtual environment (optional)</h3><div>We can make the first startup slightly faster by getting a list of the installed packages, and then installing them in the new environment.</div><div><br /><div>Using the user you run Home Assistant as, activate the old environment (here I assume it was <kbd>/srv/homeassistant/homeassistant_venv/</kbd>)and extract the list of packages (this'll speed up the first start):</div><div><div><pre>source /srv/homeassistant/homeassistant_venv/bin/activate<br />pip3 freeze â€”local &gt; ~/requirements.txt<br />deactivate</pre></div><div>Switch to the new environment, and install the requirements:</div><div><div><pre>source /srv/homeassistant/venv_3.9.7/bin/activate<br />pip3.9 install -r ~/requirements.txt</pre></div><div>If you run into any issues, remove the line in question from <kbd>requirements.txt</kbd> - this is just about speeding up the initial startup (we're almost there)</div><div><h3>Install Home Assistant</h3>Prepare the environment by installing wheel and installing/upgrading setuptools, then do an install/upgrade of Home Assistant in the new environment, before finally installing some pre requisites:</div><div><pre>source /srv/homeassistant/venv_3.9.7/bin/activate<br />python3 -m pip install wheel<br />pip3 install --upgrade setuptools<br />pip3 install --upgrade homeassistant<br />wget --quiet https://raw.githubusercontent.com/home-assistant/docker/master/requirements.txt -O - | while read LINE<br />do<br />  pip3 install --upgrade ${LINE}<br />done<br />hass --script check_config</pre></div><div style="text-align: left;">If you have issues with <kbd>pillow</kbd>, run the following command inside the venv</div><pre>pip3 install pillow --global-option="build_ext" --global-option="--enable-zlib" \<br />  --global-option="--enable-jpeg" --global-option="--enable-tiff" \<br />  --global-option="--enable-freetype" --global-option="--enable-webp" \<br />  --global-option="--enable-webpmux" --global-option="--enable-jpeg2000"<br /></pre><h3>Switch the virtual environments</h3><div>Now we're ready to switch. To do this we need to shut down HA, rename a few things, change the startup script, and start HA back up.</div><div><pre>sudo systemctl stop home-assistant<br /># Edit the path for the venv to be /srv/homeassistant/venv_3.9.7<br />sudo nano /etc/systemd/system/home-assistant@homeassistant.service<br />sudo systemctl daemon-reload<br />sudo systemctl start home-assistant<br />sudo journalctl -f -u home-assistant</pre></div><br />Here's my systemd script for this system: <br /><pre>[Unit]<br />Description=Home Assistant<br />After=network-online.target<br /><br />[Service]<br />Type=simple<br />User=homeassistant<br />ExecStart=/srv/homeassistant/venv_3.9.7/bin/hass -c "/home/homeassistant/.homeassistant"<br /><br />[Install]<br />WantedBy=multi-user.target<br /></pre><div>Now you can watch it install various packages as it starts.</div><div><h3>Why this way?</h3></div></div></div><div>This makes it pretty easy to switch between versions of Python, or even versions of Home Assistant.</div><br /></div></div>