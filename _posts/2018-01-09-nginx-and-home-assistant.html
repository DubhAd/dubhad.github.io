---
layout: post
title: NGINX and Home Assistant
date: '2018-01-09T19:44:00.001Z'
author: Tinkerer
tags:
- remote access
- home assistant
modified_time: '2018-04-29T21:38:28.266+01:00'
---

I'm going to assume that you've already got <a href="https://www.blogger.com/2017/11/letsencrypt-with-home-assistant.html">Let's Encrypt</a> or your chosen SSL provider configured, and that you've forwarded the port your using.  <br />But now you've decided you want finer grained control of access than Home Assistant can provide, or maybe you want to make some use of NGINX's other features. You've read the <a href="https://home-assistant.io/docs/ecosystem/nginx/">official guide</a> and <a href="https://community.home-assistant.io/t/homeassistant-nginx-ssl-proxy-setup/53">the forum</a> and they've left you scratching your head in confusion. What follows is a condensed version of those, based upon my own more complicated <a href="https://github.com/DubhAd/Home-AssistantConfig/tree/master/etc/nginx/conf.d">configuration</a>, but you can start simpler.  <br /><br /><h2>Installation</h2>First, install NGINX. On any Debian based distribution (such as Raspbian) you do that with: <br /><pre>$ sudo aptitude update<br />$ sudo aptitude install nginx<br /></pre>If you get an error about <code>aptitude</code> not being found then:  <br /><pre>$ sudo apt-get install aptitude<br /></pre>then try again.  <br /><h2>Configuration</h2>Then there are two files you need.  <strong><code>/etc/nginx/conf.d/proxy.conf</code></strong> <br /><br /><ul><pre>proxy_redirect off;<br />proxy_set_header Host $host;<br />proxy_set_header X-Real-IP $remote_addr;<br />proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br />client_max_body_size 10m;<br />client_body_buffer_size 128k;<br />proxy_connect_timeout 90;<br />proxy_send_timeout 90;<br />proxy_read_timeout 90;<br />proxy_buffers 32 4k;</pre></ul>In the following, change <code>yourhost.example.org</code> for your hostname  <strong><code>/etc/nginx/conf.d/yourhost.example.org.conf</code></strong> <br /><br /><ul><pre>server {<br /> listen 8443; # Must be different from your Home Assistant port<br /> server_name yourhost.example.org;<br /> access_log /var/log/nginx/yourhost.example.org.access.log;<br /> error_log /var/log/nginx/yourhost.example.org.error.log;<br /><br /> ssl on;<br /> ssl_certificate /etc/letsencrypt/live/yourhost.example.org/fullchain.pem;<br /> ssl_certificate_key /etc/letsencrypt/live/yourhost.example.org/privkey.pem;<br /><br /> proxy_buffering off;<br /><br /> location / {<br />  satisfy any; # Means that I can connect either from an allowed IP range, or with authentication<br />  allow 192.168.0.0/24; # My home network range<br />  allow 203.0.114.42/32; # My static IP from the ISP (remove if you don't have a static IP)<br /><br />  auth_basic "Restricted"; #For Basic Auth<br />  auth_basic_user_file /etc/nginx/.htpasswd; # For basic authentication, managed by htpasswd<br />  include conf.d/proxy.conf;<br />  proxy_pass http://127.0.0.1:8123; # Assumes you're running this on the same host as Home Assistant<br />  proxy_set_header Host $host;<br />  proxy_http_version 1.1;<br />  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br />  proxy_set_header Upgrade $http_upgrade;<br />  proxy_set_header Connection $connection_upgrade;<br />  proxy_set_header Authorization $http_authorization;<br />  proxy_pass_header Authorization;<br /> }<br /><br /> location /api/notify.html5/callback {<br />  if ($http_authorization = "") { return 403; }<br />  allow all;<br />  proxy_pass http://127.0.0.1:8123;<br />  proxy_set_header Host $host;<br /> }<br />}<br /></pre></ul><h2>Authentication</h2>You'll notice that I'm using authentication. You create this with the <code>htpasswd</code> command: <br /><pre>$ htpasswd -c /etc/nginx/.htpasswd myusergoeshere</pre>After you create the file, you add users with: <pre>$ htpasswd /etc/nginx/.htpasswd myotheruser</pre>If you don't want to do authentication in NGINX, remove the lines that start <code>satisfy</code>, <code>allow</code>, and <code>auth_basic</code>.  <br />Now (re)start NGINX. Then update your port forwarding on your router, so that instead of going directly to your Home Assistant port, it goes to your NGINX port.  <br /><br /><h2>Home Assistant configuration</h2>As mentioned, I'm doing authentication in NGINX. That means that in Home Assistant you can update the <a href="https://home-assistant.io/components/http/"><code>http:</code> component</a> and comment out the <code>api_password:</code> line (then restart Home Assistant) if you want to (I have). Do be aware though that if you're using <code>trusted_networks:</code> then it's likely that your NGINX server is within that if it includes your home IP range. Similarly, if you use <code>ip_ban_enabled:</code> then that will block your proxy, not the originating IP. If you want to do IP based blocking, then you'll want to install and configure <a href="https://www.fail2ban.org/wiki/index.php/Main_Page">fail2ban</a> with NGINX.<br /><br /><br /><br /><br /><br />