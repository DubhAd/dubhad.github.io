---
layout: post
title: Accessing the inaccessible
date: '2018-09-29T22:00:00.001+01:00'
author: Tinkerer
tags:
- remote access
- openvpn
- cloud
- pivpn
- home assistant
- vpn
modified_time: '2022-02-01T11:23:45.213Z'
---

<div><span style="font-size: x-small;"><i>Updated January 2022 to include details on Cloudflare's tunnel service, and Oracle's free VM offering.</i></span></div><div><br /></div>Whether you're on a mobile broadband connection, sat behind CGNAT, or suffering from DS-Lite, a number of people want to be able to remotely access their <a href="https://www.home-assistant.io/">Home Assistant</a> system, despite not having any way of getting inbound connections.<br /><br />The Home Assistant <a href="https://www.nabucasa.com/">cloud service</a>&nbsp;addresses this, but there's ways of doing it yourself.<div><br /></div><div>One of the simplest solutions is <a href="https://developers.cloudflare.com/cloudflare-one/tutorials/share-new-site" target="_blank">Cloudflare's tunnel service</a>. It's a pretty simple process, as long as you can run their relay software you can be up and running in about 15 minutes.<br /><br />Building your own relay service takes a bit of work, and you'll need a virtual machine somewhere on the cloud. That doesn't have to be expensive, it's (just) possible to run what you need on the free tier of Google Cloud Computing or AWS. If you can afford around $5 USD a month you can get a more powerful system on any of the cloud hosting providers (including Digital Ocean, or Azure). In 2021 Oracle introduced a <a href="https://www.oracle.com/uk/cloud/free/" target="_blank">free tier</a> too that's more than enough here.<br /><h3>Set up a VPN server (cloud)</h3><div>I've already talked about <a href="https://blog.ceard.tech/2018/01/remote-access-via-pivpn.html">setting up PiVPN</a>. You install this on your cloud hosted virtual machine, and the (OpenVPN) client on your Home Assistant server (yes, I'm afraid this largely rules out Hass.io at this time). Use the default TUN (tunnel) connection.<br /><br />You'll need to add firewall rules on the cloud environment to allow access to your VPN software. On Google Cloud Platform that's through the <a href="https://cloud.google.com/vpc/docs/firewalls">Firewall rules</a> section, on AWS it's with <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-network-security.html">Security Groups</a>. Azure and Digital Ocean have similar settings, if in doubt search for <i>your hosting provider</i> and <i>firewall rules</i>.<br /><h3>Set up the VPN client (home)</h3>My instructions here assume you're using the official OpenVPN client on a Debian (eg Ubuntu, Raspbian, Hassbian, etc) based system. First you install OpenVPN:<br /><pre>sudo apt install openvpn</pre>Copy the configuration file from the VPN server to <kbd>/etc/openvpn/</kbd>, but before you go any further you'll need to make some changes. The default configuration will route <i>all</i>&nbsp;the traffic for your Home Assistant system through that system, which isn't likely to be what you want. You can solve that by editing the configuration file, and adding the following line before the <kbd>&lt;ca&gt;</kbd> line:<br /><pre>route-nopull</pre>Now when the VPN starts the <i>only</i> thing that will be reachable over it is that cloud system.<br /><br />Next, add the following line to <kbd>/etc/default/openvpn</kbd><br /><pre>AUTOSTART="all"</pre>Finally, enable the client, reload the configuration and start the OpenVPN client:<br /><pre>sudo systemctl enable openvpn<br />sudo systemctl daemon-reload<br />sudo systemctl restart openvpn</pre></div>At this point you'll want to check that the VPN is established. Assuming you're using the default PiVPN configuration type:<br /><pre>ping -c 2 10.0.8.1</pre>You should see something similar to this:<br /><pre>PING 10.8.0.1 (10.8.0.1) 56(84) bytes of data.<br />64 bytes from 10.8.0.1: icmp_seq=1 ttl=64 time=39.7 ms<br />64 bytes from 10.8.0.1: icmp_seq=2 ttl=64 time=148 ms<br /><br />--- 10.8.0.1 ping statistics ---<br />2 packets transmitted, 2 received, 0% packet loss, time 1001ms<br />rtt min/avg/max/mdev = 39.724/94.045/148.366/54.321 ms</pre>Your numbers in the time and rtt values will be different, but the key thing is you get two response lines like that. If you don't then the VPN didn't start. Check on your cloud server that the VPN software is running, and check on the Home Assistant system for any errors in the logs (<kbd>/var/log/openvpn.log</kbd>)<br /><h3>Set up a reverse proxy (cloud)</h3><div>You can test that connectivity is working from this side by running this on the cloud server:<br /><pre>ping -c 2 10.0.8.2</pre>You should see something similar to this:<br /><pre>PING 10.8.0.2 (10.8.0.2) 56(84) bytes of data.<br />64 bytes from 10.8.0.2: icmp_seq=1 ttl=64 time=49.7 ms<br />64 bytes from 10.8.0.2: icmp_seq=2 ttl=64 time=48.1 ms</pre>With that working, install your choice of <a href="https://www.home-assistant.io/docs/ecosystem/nginx/">NGINX</a>, <a href="https://www.home-assistant.io/docs/ecosystem/caddy/">Caddy</a>, HA Proxy, <a href="https://www.home-assistant.io/docs/ecosystem/apache/">Apache</a> or whatever. I've got a guide for configuring an <a href="https://blog.ceard.tech/2018/01/nginx-and-home-assistant.html">older version of NGINX</a>, but it won't work on a current version without changes.<br /><br />When you configure your reverse proxy, you configure it to forward the traffic to the VPN IP of your Home Assistant system. That's easy enough to find:<br /><pre>ip addr show tun0</pre>That will spit out something like the following:<br /><pre>34: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 100<br />    link/none<br />    inet 10.8.0.2/24 brd 10.8.0.255 scope global tun0<br />        valid_lft forever preferred_lft forever<br />    inet6 fe80::dead:beef:1234:cafe/64 scope link flags 800<br />        valid_lft forever preferred_lft forever</pre>The key thing you're looking for is that third line, <strong><kbd>10.8.0.2</kbd></strong>. That's the IP address you need to use in your proxy configuration. The odds are good that it will be the same IP as I've got here though, because that's from my own system, with a VPN connection to a PiVPN system.<br /><br />On NGINX your config line will be:<br /><pre>proxy_pass http://10.8.0.2:8123;</pre></div><h3>DNS (cloud)</h3><div>Assuming you've not paid for a static IP, install your chosen DDNS update client on your VM, and configure it to update your IP as it changes. There are many clients to chose from, but <a href="https://github.com/troglobit/inadyn">inadyn</a>&nbsp;and <a href="https://sourceforge.net/p/ddclient/wiki/Home/">ddclient</a> are worth a look. You could also pay your VM provider for a static IP if you want to.</div><div><h3>HTTPS (cloud)</h3></div><div>Now you need to get SSL certificates for your proxy. If you're using Let's Encrypt then you've got <a href="https://certbot.eff.org/docs/install.html">certbot</a>, and also <a href="https://github.com/lukas2511/dehydrated">dehydrated</a>. Once you've sorted that you'll need to configure your proxy to use them, and restart the proxy when the certificate updates.<br /><br />On NGINX for example you'll have something similar to:<br /><pre>ssl on;<br />ssl_certificate /etc/letsencrypt/live/yourhost.example.com/fullchain.pem;<br />ssl_certificate_key /etc/letsencrypt/live/yourhost.example.com/privkey.pem;</pre></div><h3>All done now</h3><div>It's been a long journey to this point, but it should be done. You can now try connecting to your proxy server, and it'll connect you through to your Home Assistant server. This works because your Home Assistant server is connecting <i>out</i>&nbsp;to your cloud based server.<br /><br />Don't forget to keep your cloud server updated. Most distributions can help you there by automatically applying at least security patches.</div></div>