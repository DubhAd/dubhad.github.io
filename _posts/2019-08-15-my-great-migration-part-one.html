---
layout: post
title: My great migration - part one
date: '2019-08-15T10:45:00.002+01:00'
author: Tinkerer
tags:
- zigbee
- z-wave
- home assistant
modified_time: '2019-08-15T10:45:50.305+01:00'
---

I've been running Home Assistant on my Pi3 since I started with HA, back in January 2017. I'd chosen a <a href="https://z-wave.me/products/razberry/">Z-Wave GPIO hat</a> over a USB stick (amongst other things, because it avoided the risk of it getting disconnected in error), which has tied my Z-Wave mesh to the Pi. <br /><br />The Pi works, but disk I/O is always a challenge and startup times are long. Upgrades of the venv can take up to an hour if things have to be compiled. As such, it's time to plan a migration.<br /><br />I've got two sensible long term options:<br /><ol><li>Buy the same manufacturer's <a href="https://z-wave.me/uzb/">Z-Wave USB stick</a>, back up the hat, restore it to the stick</li><li>Migrate to <a href="https://github.com/OpenZWave/Zwave2Mqtt">Zwave2MQTT</a></li></ol><div>The first has the advantage that I don't have to change anything else, but the downside that every time I restart HA I get to see if the Python OpenZWave cache file will be corrupted and crash HA on startup again. This is an odd edge case that most people seem to avoid, but quite a few of us have been randomly hit by.</div><div><br /></div><div>The second means I can place my Z-Wave controller where it's central, rather than the current location, and also that restarts of HA don't impact the mesh. I'm also already using MQTT for <a href="https://www.zigbee2mqtt.io/">Zigbee2MQTT</a> and <a href="https://github.com/andrewjfreyer/monitor">monitor</a>.</div><h3>Initial attempts with Zwave2MQTT</h3><div>My first attempt to compile the NodeJS package worked, but didn't create the required bundle for some reason. The next attempt to compile caused the Pi to busy out for 5 minutes, with load values passing 50. As that's my Home Assistant server, that was a problem, and it got killed. I haven't tackled that since.</div><div><br /></div><div>I've put this on hold until a future date. I'll buy another Pi (may as well buy a Pi4, but I'll wait to see if they're going to fix the USB-C charger issue) and possibly install Hass.io there so I can use <a href="https://github.com/hassio-addons/addon-zwave2mqtt">Frenck's Zwave2MQTT add-on</a>.</div><h3>What to do until then?</h3><div>The answer was easy - hack it!</div><div><ol><li>Configure the Pi instance to use <a href="https://www.home-assistant.io/components/mqtt_statestream">MQTT statestream</a> and send the states and attributes of the Z-Wave related entities</li><li>Manually configure MQTT sensors and switches on the VM instance</li><li>Test!</li></ol><div>MQTT Statestream is only one way, so I was getting the information I needed in the VM, but couldn't control anything. Some quick hackery with some MQTT binary sensors (to read the state of a fake command topic) and automations (one for publishing the state of the switch to the command topic if the switch changes state and the command topic isn't the same; one for calling the API of the Pi instance to control the switch) and it lives!</div></div><h3>Next steps</h3><div>Now is the gentle grind of migrating, well, pretty much everything. The biggest challenge was sorting out the remote webhooks, for GPS Logger and Tasker, such that they would update both instances while I transition, without changing anything on the mobile devices. As I'm using NGINX I could pull together a quick CGI script to act as a splitter, receiving the payloads and sending them to both instances.</div><div><br /></div><div>Since then, it's just been a case of migrating blocks of automations at a time, as I get time. I'm expecting that this may drag on a bit, life over the last 6 months or so has left me little free time to tackle anything of note, but there's no rush.</div>