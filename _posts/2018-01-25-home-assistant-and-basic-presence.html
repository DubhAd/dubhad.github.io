---
layout: post
title: Home Assistant and (basic) Presence Detection
date: '2018-01-25T00:00:00.000Z'
author: Tinkerer
tags:
- home assistant
- presence detection
modified_time: '2018-02-24T09:26:16.086Z'
---

Reliable presence detection is a challenge for many people. In part this is because modern smartphones put WiFi (and apps) to sleep when they're idle.<br /><br />There are many ways of approaching this (just look at the threads on the <a href="https://community.home-assistant.io/">Home Assistant forum</a> to see), but here's how I've tackled it with a range of Android devices.<br /><h3>At home tracking</h3><div>For on network detection I use&nbsp;<a href="https://home-assistant.io/components/device_tracker.nmap_tracker/">nmap</a>. My router isn't directly supported, and since I allocate a small range for mobile devices, nmap works well. I also use it for detecting whether some of the media players (and other devices) are on.</div><div><br /></div><div>The problem (as mentioned above) is that modern smartphones turn off WiFi when they're idle, at which point the device ends up marked as away. Fortunately they don't turn off Bluetooth, so I also use the <a href="https://home-assistant.io/components/device_tracker.bluetooth_tracker/">Bluetooth tracker</a>. I did make the mistake of putting my Home Assistant system in one corner of the house, so Bluetooth doesn't <i>quite</i>&nbsp;reach the opposite corner of the house reliably. The dead zone however is barely 0.5MÂ², so it's not a big deal.<br /><h3>General location tracking</h3><div>I use&nbsp;<a href="https://code.mendhak.com/gpslogger/">GPSLogger</a>&nbsp;on Android for location tracking. This allows me to detect if people enter or leave&nbsp;<a href="https://home-assistant.io/components/zone/">a zone</a>, and see how long it would&nbsp;<a href="https://home-assistant.io/components/sensor.google_travel_time/">take them to get home</a>&nbsp;- no point in putting the dinner on for 6 PM if nobody will be home before 7 after all.<br /><br />The settings are default, other than:<br /><ul><li>Start on boot and app launch</li><li>Hide the notification buttons and from the status bar</li><li>Location providers of GPS and Passive. One one device I've disabled <i>Network</i>&nbsp;as a test of the impact. So far, it appears to be insignificant.</li><li>Logging interval of 900 seconds (15 minutes) on my tablet, and 600 seconds (10 minutes) on everything else</li><li>Accuracy filter of 200</li><li>Logging to URL</li></ul>The battery impact is irrelevant - 1% usage at the end of a typical day.<br /><br />Geo-location like this I find useful for various automations, like letting whichever of us is at home know the other is on their way (handy for asking them to detour by the shops to grab something). It's also used in an automation when I'm in the office, to let me know the state of the trains for the commute home.</div></div><h3>Bringing it together</h3><div>Now I can group these trackers (nmap, Bluetooth, and GPSLogger). When any one of them shows as home, I am then at home. This is largely where I have things now, and it's proven very reliable.</div><pre>group:<br />  person_tinkerer:<br />    name: Tinkerer<br />    view: false<br />    entities:<br />    - device_tracker.tinkerer_mobile_nmap<br />    - device_tracker.tinkerer_mobile_bt<br />    - device_tracker.tinkerer_mobile<br /><br />customize:<br />  group.person_tinkerer:<br />    entity_picture: /local/tinkerer.jpg</pre><h3>Wait! There's more</h3>Having home/away is slightly useful, but I like to display where people are, and if not in a zone how long it would take them to get home (really useful for planning dinner). For that I have a template sensor for each person which displays the zone (home or other) if we're in one, otherwise how long it'll take to get home: <br /><pre>sensor:<br />  - platform: template<br />    sensors:<br />      tinkerer_travel:<br />        friendly_name: "Tinkerer's location"<br />        value_template: &gt;-<br />          {{ "{%" }}- if is_state("group.person_tinkerer", "home") -%}<br />            At home<br />          {{ "{%" }}- elif is_state("device_tracker.tinkerer_mobile", "not_home") -%}<br />            {{ "{{" }} states.sensor.tinkerers_time_to_home.attributes.duration }} to home<br />          {{ "{%" }}- else -%}<br />            At {{ "{{" }} states("device_tracker.tinkerer_mobile") }} <br />          {{ "{%" }}- endif %}'</pre>And then, for display, I'll add my picture:<br /><pre>customize:<br />  sensor.tinkerer_travel:<br />    entity_picture: /local/tinkerer.jpg<br /></pre><h3>Moving further</h3><div>However, there's more to it than just where people's mobile devices are. If somebody's at home, the chances are there's a TV, or a media player, or a PC on. Some of us have other devices (like smart watches) that can also be used. Then there's whether or not external doors have been opened, after all if no door has opened, we can't have left home.<br /><br />I also could go a step further and use a&nbsp;<a href="https://home-assistant.io/components/binary_sensor.bayesian/">bayesian sensor</a>, or a&nbsp;<a href="https://home-assistant.io/components/binary_sensor.template/">template sensor</a>, such that I need at least two out of the three showing at home before I'm considered at home, but any one is enough to keep me at home.<br /><br />I haven't done any of this yet, as what I'm doing currently works really well, but I'm likely to explore this over time. I'm also exploring Phil Hawthorne's work on <a href="https://philhawthorne.com/making-home-assistants-presence-detection-not-so-binary/">making detection less binary</a>.</div><br /><b><i>Footnotes</i></b><br /><ol><li><i>I was using OwnTracks, but there's a&nbsp;<a href="https://github.com/owntracks/android/issues/508">known issue</a>&nbsp;where it'll randomly turn off reporting. It doesn't help that the Android app was abandoned due to the lack of a maintainer, though it looks like a replacement is now in hand.</i></li></ol><br /><br /><br />