---
layout: post
title: Presence Detection Resurrection
date: '2021-01-03T01:00:00.001Z'
author: Tinkerer
tags:
- bluetooth
- home assistant
- presence detection
modified_time: '2021-01-03T01:00:00.518Z'
---

Yes, another update. Until I start using Blueprints I think this'll be the last one for a while. Probably.<br /><br />Oh, you may want to grab a cuppa before you dive in, this is a long one as I wanted to cover <i>everything</i>&nbsp;relevant in one article.<br /><h3>Goal</h3><div>The goal here is to have&nbsp;<i>quick and reliable&nbsp;</i>home/away detection. This is for a few key things:<br /><ol><li>Let us know we left a door or window open when we left the house, before we've got too far</li><li>Turning on lights as we get home</li><li>Manage a number of automations that are based around whether we're home, or away</li></ol><div>We can't have false aways, turning things off unexpectedly is a good way of annoying people. It can't leave people marked as being home when they're clearly not, as then people don't get told about open doors or windows soon enough.</div></div><div><h4>The problem</h4>Grouping device trackers was the traditional approach, but it means that if <i>any</i>&nbsp;tracker thinks the device is home, then you're home. The result isn't very useful if you've included GPS trackers in that group. The early stages of the <a href="https://www.home-assistant.io/integrations/person/" target="_blank">person integration</a> had a "most recent update wins" approach which didn't help as you'd easily flip between home and away. The more recent updates to person have made it better, but it still takes a "most recent update wins" approach amongst the non-GPS trackers. That's fine if you've only got one local presence detection integration, and it's 100% reliable.<br /><br />Importantly, I want to ensure that a phone running out of battery doesn't cause a false away. That means that having local device trackers report away shouldn't necessarily cause somebody to be marked away.<br /><br />Finally, I need to allow for edge cases with things breaking. It's not going to be the first time that one of the nodes responsible for Bluetooth tracking has silently failed. Back when I was using a different WiFi based detection integration I also had that fail (actually, it caused the router to run out of memory). The results of those failures were that some devices were locked home, and some were locked away.<br /><h4>GPS</h4><div>GPS trackers update intermittently, more so if you're on iOS where the application has no control over update intervals. GPS also has issues when you're indoors, the deeper you go, the worse it gets. The default home zone of 100 meters occasionally resulted in the GPS tracker giving false away reports, worst case a few times a day. Departure is also slow, very slow, and we could be marked as home when we're just passing, or visiting a neighbour. This rules out GPS being a <i>timely or accurate</i>&nbsp;indicator of whether or not we're actually home.</div><h4>WiFi</h4></div><div>WiFi is the obvious alternative, but it has one problem, most modern mobile phones put their WiFi to sleep when they're in deep sleep. This saves battery, and means that you'll often see that your WiFi tracker flips between home and away a lot. This makes it horribly unreliable for our purposes.</div><h4>Bluetooth</h4><div>Phones don't put Bluetooth to sleep, and while once up on a time having Bluetooth enabled was a significant battery drain, this is no longer the case. Sure, there's <i>some</i>&nbsp;drain, but compared to everything else you're burning battery life on, particularly the screen, it's irrelevant - and likely far less than many of the apps you've installed are responsible for. Besides, in this house we all use Bluetooth for fitness trackers, smart watches, or headphones so it's on anyway.<br /><br />The downside (and upside) is that Bluetooth is shorter range than WiFi, so one single detection node isn't enough.</div><h4>Summary</h4><div>We're juggling a few things here:</div><div><ul><li>Arrivals and departures should be quickly&nbsp;<i>and reliably&nbsp;</i>detected without false positives</li><li>People shouldn't be marked as away simply because their phone is out of battery</li><li>If people are clearly not home, they shouldn't be marked as home</li><li>Bluetooth is reliable, but short range, WiFi is longer range, but unreliable</li></ul></div><h3>Ingredients</h3><div>We're combining:</div><div><ul><li>One template sensor</li><li>One motion sensor</li><li>Two door sensors</li><li>Two external programs</li><li>Four automations</li><li>Five scripts</li><li>Six integrations<br /></li></ul><hr /><h3>Template sensor</h3>I use a template sensor to provide an indicator of how many people are home.</div><div><pre>sensor:<br />- platform: template<br />  sensors:<br />    home_count:<br />      friendly_name: 'Home count'<br />      unique_id: 'home_count'<br />      value_template: &gt;-<br />        {{ "{{" }} ((expand('group.my_people')|selectattr('state', 'eq', 'on')|map(attribute='name')|list|count)/(expand('group.my_people')|map(attribute='name')|list|count))|round(2) }}<br /></pre></div>This gives me a value of between zero (nobody home) and one (everybody home).<div><br /><hr /><h3>Motion sensors</h3>I have motion sensors in various places around the house, but here the key one is the one in the vestibule. That sensor covers the area just inside the front door, so you can't exit the house without tripping it.</div><div><br /></div><div>I'm using a Xiaomi Aqara Human Body Movement sensor there, but any motion sensor will do. I connect these to Home Assistant using <a href="https://www.zigbee2mqtt.io/" target="_blank">Zigbee2MQTT</a>.<br /><br /><hr /><h3>Door sensors</h3>I've installed sensors on all the external doors (and windows). These serve a range of purposes, controlling the garden lights, reminding us to close the doors/windows if it's cold outside, warning us the garage door was left open, and more.<br /><br />It also means we can tell if somebody <i>could</i>&nbsp;have left the house. For simplicity I'm only interested in the front door and the garage door (for the car). It would be trivial to extend this to other doors, but we never use those to leave or return, and don't go jumping out of windows.<br /><br />I've got two different types of door sensors, the house doors have the <a href="https://sensative.com/sensors/strips-zwave/guard/" target="_blank">Sensative Strips Guard</a>&nbsp;(there's now a 700 series version, and a LoRA version), and the garage doors have a previous generation <a href="https://www.fibaro.com/en/products/door-window-sensor/" target="_blank">Fibaro door/window sensor</a>. All the windows use the <a href="https://www.aqara.com/en/door_and_window_sensor.html" target="_blank">Xiaomi Aqara sensors</a>, which are significantly cheaper than the Fibaro (and the Sensative, but the Sensative are invisible once fitted).<br /><br />The door sensors are also used to start departure and arrival scans in <i>monitor</i>&nbsp;(which we'll get to shortly)<br /><br /><hr /><h3>Mosquitto</h3><div>I use <a href="https://mosquitto.org/" target="_blank">Mosquitto</a>&nbsp;as my MQTT broker, as most people will. You can run this as an add-on, a Docker container, or natively. I run it on the same host I run my MariaDB server, but it can run anywhere.<br /><br />Mosquitto is required for <i>monitor</i>&nbsp;to communicate with Home Assistant, and also Zigbee2MQTT for my Zigbee devices.</div><br /><hr /><h3>Monitor</h3><div><a href="https://github.com/andrewjfreyer/monitor" target="_blank">Monitor</a> is a&nbsp;<i>passive Bluetooth presence detection of beacons, cell phones, and other Bluetooth devices. Useful for mqtt-based home automation, especially when the script runs on multiple devices, distributed throughout a property.</i>&nbsp;You run it on one or more systems in your house, and it reports on the presence, or absence, of your chosen devices.</div><div><br /></div><div>Why do I use this instead of the built in <a href="https://www.home-assistant.io/integrations/bluetooth_tracker/" target="_blank">Bluetooth tracker</a>? Three main reasons:</div><div><ol><li>At one point the Bluetooth tracker was literally adding about 5 minutes to the start of my instance. I've no idea why, but others saw similar things, if nothing quite so extreme.</li><li>It reports on <i>every device it ever sees</i>. This is <i>noisy </i>if you live near a public road, with neighbours nearby, etc. Of course, if you want to track your neighbours coming and going...</li><li>It works really well for one small part of the house - near the system running Home Assistant - and not at all for the rest of the house.</li></ol><div>For those of you running Supervised, there's a <a href="https://github.com/Limych/addon-presence-monitor" target="_blank">convenient add-on</a>&nbsp;- if your HA system is located somewhere suitable. Regardless, some low-ish end system is enough. I'm running one instance on an <a href="http://www.orangepi.org/orangepizerolts/" target="_blank">Orange Pi Zero LTS</a>, and another on a Pi3B. I had a couple of Pi Zero units, but they would randomly stop responding. The Orange Pi locked up a couple of times while I was testing, but has been reliable in production.</div></div><div><br /></div><div>Basically, set up one or more installs of <i>monitor</i>&nbsp;around your house, as you need. I've got one running in the front corner of the house (the Orange Pi), where it can easily detect us arriving, and the other in the opposite corner of the house (the Pi3B). That provides full coverage of the house, the garage, and the approach.</div><div><br /></div><div>I have both installs configured to do arrival scans automatically, but departure scans only on demand.</div><h4>systemd unit file</h4><div><pre>[Unit]<br />Description=Monitor Service<br />After=network.target<br /><br />[Service]<br />User=root<br />ExecStart=/bin/bash /local/bin/monitor/monitor.sh -x -b -tdr &amp;<br />WorkingDirectory=/local/bin/monitor<br />Restart=always<br />RestartSec=10<br /><br />[Install]<br />WantedBy=multi-user.target network.target</pre></div><div>The flags there are: <br /><ul><dt><kbd>-x</kbd></dt><dd>Sets the MQTT retain flag, so that if HA restarts it gets the last status message.</dd><dt><kbd>-b</kbd></dt><dd>Listens for beacons, as I use a (Chipolo) beacon for the car.</dd><dt><kbd>-tdr</kbd></dt><dd>Only does departure scans when told, and tells other devices to do arrival (or departure) scans when it does a scan. Arrival scans are automatic, based on the filters below.</dd></ul><h4>behaviour_preferences</h4><div>Except where specified these are all at the defaults</div><pre>#MAX RETRY ATTEMPTS FOR ARRIVAL (default is one)<br />PREF_ARRIVAL_SCAN_ATTEMPTS=2<br /><br />#MAX RETRY ATTEMPTS FOR DEPART<br />PREF_DEPART_SCAN_ATTEMPTS=2<br /><br />#SECONDS UNTIL A BEACON IS CONSIDERED EXPIRED<br />PREF_BEACON_EXPIRATION=240<br /><br />#MINIMUM TIME BEWTEEN THE SAME TYPE OF SCAN (ARRIVE SCAN, DEPART SCAN)<br />PREF_MINIMUM_TIME_BETWEEN_SCANS=15<br /><br />#ARRIVE TRIGGER FILTER(S)<br />PREF_PASS_FILTER_ADV_FLAGS_ARRIVE=".*"<br />#PREF_PASS_FILTER_MANUFACTURER_ARRIVE=".*"<br /># Limit to just the devices I care about<br />PREF_PASS_FILTER_MANUFACTURER_ARRIVE="Google|Intel|Hon Hai|HUAWEI|HTC Corporation|Apple|LG Electronics|Chipolo|Doro"<br /><br />#ARRIVE TRIGGER NEGATIVE FILTER(S)<br />PREF_FAIL_FILTER_ADV_FLAGS_ARRIVE="NONE"<br />PREF_FAIL_FILTER_MANUFACTURER_ARRIVE="NONE"<br /><br /># Default is -75, which doesn't pick up my Chipolo beacon well enough<br />PREF_RSSI_IGNORE_BELOW=-95<br /># Default is false, but we want device tracker entires<br />PREF_DEVICE_TRACKER_REPORT=true</pre><h4>mqtt_preferences</h4></div><div><pre># IP ADDRESS OR HOSTNAME OF MQTT BROKER<br />mqtt_address=192.168.0.30<br /><br /># MQTT BROKER USERNAME (OR BLANK FOR NONE)<br />mqtt_user='monitorfff'<br /><br /># MQTT BROKER PASSWORD (OR BLANK FOR NONE)<br />mqtt_password='super$ecretPa55word'<br /><br /># MQTT PUBLISH TOPIC ROOT<br />mqtt_topicpath=monitor<br /><br /># PUBLISHER IDENTITY<br />mqtt_publisher_identity='first floor front'<br /><br /># The rest of this is default<br /># MQTT PORT<br />mqtt_port='1883'<br /><br /># MQTT CERTIFICATE FILE (LEAVE BLANK IF NONE)<br />mqtt_certificate_path=''<br /><br />#MQTT VERSION (LEAVE BLANK FOR DEFAULT; EXAMPLE: 'mqttv311')<br />mqtt_version=''<br /></pre></div>This as you can guess is from the unit at the front, on the first floor. The other has a different identity (<kbd>first floor rear</kbd> - creative or what).<br /><br />The only thing left to do is to populate <kbd>known_static_addresses</kbd> with the Bluetooth addresses of the things I care about, and what I want them known as. For example<br /><pre>58:cb:52:24:53:15 person1 mobile<br />3C:28:6D:DA:EB:A1 person2 mobile</pre>Now when I start <i>monitor</i>&nbsp;it'll update the topics <kbd>monitor/first floor front/person1_mobile/device_tracker</kbd> and <kbd>monitor/first floor front/person2_mobile/device_tracker</kbd> with <kbd>home</kbd> or <kbd>not_home</kbd> accordingly. There will be other things it does, but that's all I'm caring about.<br /><br /><hr /><h3>Integrations</h3></div><div>The integrations we're using are for:</div><div><ul><li>WiFi tracking - the <a href="https://www.home-assistant.io/integrations/nmap_tracker" target="_blank">nmap tracker</a></li><li><a href="https://www.home-assistant.io/docs/mqtt/broker#run-your-own" target="_blank">MQTT</a> - for the Bluetooth tracker</li><li><a href="https://www.home-assistant.io/integrations/device_tracker.mqtt" target="_blank">MQTT device tracker</a> - for the Bluetooth tracker</li><li>GPS - I'm using <a href="https://www.home-assistant.io/integrations/gpslogger" target="_blank">GPSLogger</a>, but any will do</li><li><a href="https://www.home-assistant.io/integrations/proximity" target="_blank">Proximity</a> - for how near home the phone is</li><li><a href="https://www.home-assistant.io/integrations/group" target="_blank">Group</a> - to merge things together</li><li><a href="https://www.home-assistant.io/integrations/template" target="_blank">Template sensor</a> - to track the percentage of people home</li></ul><h4>NMAP</h4></div><div>The configuration here for the <a href="https://home-assistant.io/integrations/nmap_tracker" target="_blank">nmap tracker</a> is <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/device_tracker/nmap_tracker.yaml" target="_blank">pretty simple</a>, scan everything except the HA host:</div><div><pre>device_tracker:<br />- platform: nmap_tracker<br />  interval_seconds: 20<br />  consider_home: 50<br />  track_new_devices: yes<br />  scan_options: " --privileged -F -n --host-timeout 10s --exclude 192.168.0.10 "<br />  hosts:<br />  - 192.168.0.0/24</pre></div><div>This scans every 20 seconds, and once something responds it's assumed to be there for the next 50 seconds. The HA developers have been discussing removing consider_home, at which point I'll revisit the settings I use.<br /><h4>MQTT</h4></div><div>I used the manual (YAML) definition for the <a href="https://www.home-assistant.io/docs/mqtt/broker#run-your-own" target="_blank">MQTT broker</a> so <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/master/mqtt.yaml" target="_blank">I can define</a> the birth and will messages - though the UI integration now finally enables these by default. It uses my local MQTT broker (Mosquitto):<br /><pre>mqtt:<br />  broker: !secret mqtt_host<br />  username: !secret mqtt_user<br />  password: !secret mqtt_pass<br />  discovery: true<br />  discovery_prefix: homeassistant<br />  birth_message:<br />    topic: 'hass/status'<br />    payload: 'online'<br />  will_message:<br />    topic: 'hass/status'<br />    payload: 'offline'</pre>Beyond the basics, none of this is needed here. MQTT discovery, and the birth/will part, are required for Zigbee2MQTT, not <i>monitor</i>. We just want it set up so we can use the ...<br /><h4>MQTT Device Tracker</h4>These <a href="https://www.home-assistant.io/integrations/device_tracker.mqtt" target="_blank">MQTT device trackers</a> link the topics created by <i>monitor</i>, explained above, to <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/device_tracker/mqtt.yaml" target="_blank">device tracker entities</a>:<br /><pre>device_tracker:<br />- platform: mqtt<br />  source_type: 'bluetooth'<br />  devices:<br />    person1_bt_mobile: 'monitor/first floor rear/person1_mobile/device_tracker'<br />    person1_bt_front_mobile: 'monitor/first floor front/person1_mobile/device_tracker'<br />  ...</pre>I have two instances of <i>monitor</i>, so each device has two device trackers.<br /><h4>GPSLogger</h4>Any GPS tracker will do here. I use <a href="https://www.home-assistant.io/integrations/gpslogger" target="_blank">GPSLogger</a>&nbsp;over others for two main reasons:<br /><ol><li>I'm an Android user, and I use <a href="https://tasker.joaoapps.com/" target="_blank">Tasker</a>, allowing me to automate my phone. GPSLogger has support for <i>intents</i>, allowing me to control it from Tasker. This means I can change the settings to, say, disable GPS and increase the intervals if I'm in the office (which right now is not relevant admittedly).</li><li>It's <i>very</i>&nbsp;configurable. I can have it update at the speed I want, with the accuracy that interests me, etc. Typically I have it updating every 5 to 10 minutes, with a desired accuracy of 200 meters - it won't report if it can't provide an accuracy of at least that. When I'm in the office I have Tasker change the interval to 30 minutes, and the accuracy to 800.</li></ol><div>Why do I mention GPS tracking, when I said at the start it can be too slow? I use it for a number of other things, but here I want it for ...</div><h4>Proximity</h4><div>The <a href="https://www.home-assistant.io/integrations/proximity" target="_blank">proximity integration</a> provides me with a <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/proximity/person1_home.yaml" target="_blank">distance from home</a>&nbsp;in meters (amongst other places). This is used in the automations to account for a couple of edge cases that I'll explain when we get to that.</div><div><pre>proximity:<br />- person1_home:<br />    zone: home<br />    devices:<br />    - device_tracker.person1_mobile<br />    unit_of_measurement: m<br /></pre></div><h4>Group</h4><div>I use <a href="https://www.home-assistant.io/integrations/group" target="_blank">groups</a> for a bunch of things, but here what I do is <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/groups/person_person1.yaml" target="_blank">group all the non-GPS trackers</a> for each person, to make my automations "easier".<br /><pre>group:<br />  person_person1:<br />    name: person1<br />    entities:<br />    - device_tracker.3c_28_6d_da_eb_a1<br />    - device_tracker.person1_bt_mobile<br />    - device_tracker.person1_bt_front_mobile</pre>These are used in the automations, not in triggers, but in the conditions.<br /><br /></div></div><hr /><h3>Scripts</h3><div>Yes, we're done with all the foundation work. Finally.<br /><br />There's a <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/scripts/people/person1/person1_home.yaml" target="_blank">home</a>, and an <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/scripts/people/person1/person1_away.yaml" target="_blank">away</a>, <a href="https://www.home-assistant.io/integrations/script" target="_blank">script</a> for each person. The full scripts are linked, but I've posted the key parts that are relevant here:</div><div><pre>script:<br />  person1_home:<br />    alias: person1 home<br />    sequence:<br />    # Everybody has a boolean that defines if they're home or away. They're home, <br />    #  so turn it on<br />    - service: input_boolean.turn_on<br />      entity_id: input_boolean.person1_home<br /><br />  person1_away:<br />    alias: person1 away<br />    sequence:<br />    # Turn off the boolean showing they're home<br />    - service: input_boolean.turn_off<br />      entity_id: input_boolean.person1_home</pre></div><div>Yes, pretty much all those scripts are doing for presence detection is turning a boolean on and off to indicate home/away. At least for the purposes here, the full scripts do more things for other purposes. I use those booleans for home/away logic, not any group, person, or device tracker entity.</div><div><br /></div><div>The main script now is one for <a href="https://blog.ceard.tech/2020/04/presence-detection-one-last-time.html" target="_blank">doing the scans</a>. This uses a bunch of logic to work out whether we can do just a departure scan, or just an arrival scan, or whether we should do both. At 116 lines I won't put it in here, but the basic logic is:</div><div><ul style="text-align: left;"><li>If nobody is home, do an away scan</li><li>If everybody is home, do a departure scan</li><li>If the far garage door, for the freezer, is already open do nothing (since it's likely we're just going out to the freezer)</li><li>There was motion in the vestibule, do a departure scan, then an arrival scan (it's possible somebody forgot their key)</li><li>There was no motion in the vestibule, do an arrival scan</li><li>None of these (fall through), do an arrival scan, then a departure scan</li></ul>There's also scripts for <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/scripts/scan_bt_depart.yaml" target="_blank">departure</a> and <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/master/scripts/scan_bt_arrive.yaml" target="_blank">arrival</a> scans. We only <i>really </i>need the departure scan script, since we told <i>monitor</i>&nbsp;to only do departure scans on demand, not automatically. The arrival scans however speed up detection, probably by 20 to 30 seconds.</div><div><br />The departure scan waits to ensure that we're not doing an arrival scan, and then runs five departure scans, with various delays, stopping if everybody is away. This allows for the many times we stand just outside the house chatting with the neighbours. The arrival scan does three arrival scans, 30 seconds apart, stopping if everybody is home.<br /><br /><hr /><h3>Automations</h3>Now we bring it all together into one relatively simple, and one not quite so simple, <a href="https://www.home-assistant.io/docs/automation/" target="_blank">automation</a>&nbsp;for presence detection.</div><h4>Home</h4><div>The <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/automation/people/person1/person1_home.yaml" target="_blank">home automation</a> was relatively simple, but has become a bit more complicated:</div><div><br /></div><div><b>Triggers</b>: Any device tracker shows home, the front door opens/closes, HA starts</div><div><b>Conditions</b>: Multiple trackers show home, or the door just opened/closed and at least one shows home</div><div><pre>automation:<br />- initial_state: 'on'<br />  alias: 'person1 home'<br />  trigger:<br />  # Trigger when any of their local trackers show home<br />  - platform: state<br />    entity_id: <br />      - device_tracker.3c_28_6d_da_eb_a1<br />      - device_tracker.person1_bt_mobile<br />      - device_tracker.person1_bt_front_mobile<br />    to: 'home'<br />  # When the front door opens or closes<br />  - platform: state<br />    entity_id: binary_sensor.pi3_front_door_sensor<br />    to: 'off'<br />  - platform: state<br />    entity_id: binary_sensor.pi3_front_door_sensor<br />    to: 'on'<br />  # Trigger when HA starts<br />  - platform: homeassistant<br />    event: start<br />  condition:<br />  # Either the door just opened/closed, or multiple trackers show home<br />  - condition: or<br />    conditions:<br />    - condition: numeric_state<br />      entity_id: group.person_person1<br />      above: 1<br />      value_template: "{{ "{{" }} dict((states|selectattr('entity_id', 'in', state_attr('group.person_person1', 'entity_id'))|list)|groupby('state'))['home']|count }}"<br />    - condition: and<br />      conditions:<br />      - condition: template<br />        value_template: &gt;-<br />          {{ "{{" }} ((now() - states.binary_sensor.pi3_front_door_sensor.last_changed).seconds &lt; 60 ) }}<br />      - condition: numeric_state<br />        entity_id: group.person_person1<br />        above: 0<br />        value_template: "{{ "{{" }} dict((states|selectattr('entity_id', 'in', state_attr('group.person_person1', 'entity_id'))|list)|groupby('state'))['home']|count }}"<br />  action:<br />  # Call the script we wrote above<br />  - service: script.person1_home</pre></div><div>We're just looking for any sign they're home. I don't use the group in the trigger because it's possible we marked somebody as away despite not every group member being away. That means that the status of the group will remain home, so not change when another tracker marks them as home.</div><div><h3>Away</h3></div><div>The <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/automation/people/person1/person1_away.yaml" target="_blank">away automation</a> is the strangely complicated one. I'll break this one down rather than posting it as a one.<br /><br />The first two trigger statements are for when the GPS tracker says we're away, and far away. These catch the edge cases:<br /><pre>  trigger:<br />  - platform: numeric_state<br />    entity_id: proximity.person1_home<br />    above: 300<br />  - platform: numeric_state<br />    entity_id: proximity.person1_home<br />    above: 600</pre>The next two are the typical ones, devices being away, and HA starting:<br /><pre>  - platform: state<br />    entity_id: <br />      - device_tracker.3c_28_6d_da_eb_a1<br />      - device_tracker.person1_bt_mobile<br />      - device_tracker.person1_bt_front_mobile<br />    to: 'not_home'<br />  - platform: homeassistant<br />    event: start</pre>Next up, we define a bunch of variables <pre>variables:<br />  away_count: "{{ "{{" }} dict((states|selectattr('entity_id', 'in', state_attr('group.person_person1', 'entity_id'))|list)|groupby('state'))['not_home']|count }}"<br />  door_recent: "{{ "{{" }} ((now() - states.binary_sensor.pi3_front_door_sensor.last_changed).seconds &lt; 300) or ((now() - states.binary_sensor.pi3_garage_closed_car_sensor.last_changed).seconds &lt; 300) }}"<br />  is_home: "{{ "{{" }} is_state('input_boolean.person1_home','on') }}"<br />  proximity_home: "{{ "{{" }} states('proximity.person1_home') }}"<br />  away_script: script.person1_away</pre>These are the first step towards using <a href="https://www.home-assistant.io/docs/automation/using_blueprints/">Blueprints</a>. We're defining some standard values that we can use in the conditions and actions later.    The first condition check is that we're home, if we're not home there's no point in doing this all over again:<br /><pre>  condition:<br />  - condition: template<br />    value_template: "{{ "{{" }} is_home == 'True' }}"</pre>Now we have three blocks any one of which has to be true.<br /><br />First off, an exit door has to have opened/closed in the last 5 minutes, and at least two trackers show away. Why two? Well it's quite normal for one tracker to be showing away at any given time, due to the layout of the house, or the phone being in deep sleep.<br /><pre>    - condition: and<br />      conditions:<br />      # More than one tracker shows away<br />      - condition: template<br />        value_template: "{{ "{{" }} away_count|int &gt; 1 }}"<br />      # An exit door recently opened or closed<br />      - condition: template<br />        value_template: "{{ "{{" }} door_recent == 'True' }}"<br /></pre>Alternatively at least one devices are showing away, and we're not that close. This exists because it wouldn't be the first time we've stood just outside chatting with a neighbour for more than 5 minutes. Three hundred meters is far enough beyond the accuracy level set for GPSLogger that there's no chance of getting a false away with this.<br /><pre>    - condition: and<br />      conditions:<br />      - condition: template<br />        value_template: "{{ "{{" }} away_count|int &gt; 0 }}"<br />      - condition: template<br />        value_template: "{{ "{{" }} proximity_home|int &gt; 300 }}"<br /></pre>Finally, to account for all of the trackers locking up (and/or us spending an age chatting with the neighbours), we'll accept that it may also be that we're just far away:<br /><pre>    - condition: template<br />      value_template: "{{ "{{" }} proximity_home|int &gt; 600 }}"<br /></pre>Finally, we call the script:<br /><pre>  action:<br />  - service: script.person1_away</pre></div>If you're still with me, what this means is that we're marked away when:<br /><ul><li>At least two trackers show away if an exit door closed in the last 5 minutes</li><li>All trackers&nbsp;show away, and we're at least 300 meters away (remember GPSLogger won't report if it doesn't have an accuracy of at least 200 meters)</li><li>At least two trackers&nbsp;show away, and we're at least 600 meters away</li></ul><div>The other automation runs the scan script when the door <a href="https://github.com/DubhAd/Home-AssistantConfig/blob/live/automation/front_of_house/front_door_open.yaml" target="_blank">opens</a>.</div><div><pre>automation:<br />- alias: 'Front door open'<br />  initial_state: 'on'<br />  trigger:<br />  - platform: state<br />    entity_id: binary_sensor.pi3_front_door_sensor<br />    to: 'on'<br />  action:<br />  - service: automation.turn_off<br />    data:<br />      entity_id: automation.garage_open_nobody_home<br />  - service: script.turn_on<br />    entity_id: script.scan_bt</pre></div>There are also automations for the garage door.<br /><br /><hr /><h3>But why?</h3><div>I know, you're looking at this and thinking <i>this is horribly complicated</i>. Well, it is, and it isn't. If the behaviour of person works for you, great. It didn't work for me though, which is why I created this.<br /><br />This gives me a presence detection method that is always quick to detect arrival. Importantly it never produces any false away, and at worst will have a short delay before marking people away.<br /><h4>Room presence</h4></div><div>It's been asked a few times if I do any room level presence detection, and the answer is <i>not by tracking phones</i>. It's of little value to me to know where somebody may have left a phone, or a tablet. I much prefer to track the people and their behaviours.</div><br /><hr /><h3>Next?</h3><div>The obvious thing is to use <a href="https://www.home-assistant.io/docs/automation/using_blueprints/" target="_blank">Blueprints</a>. I just need to upgrade HA first. At the time of writing this I'm still a couple of releases too old for those.</div><div><br /></div><div>The other thing I should do is if one of the distance conditions is tripped is run a departure scan again, and if that still shows the person is home force a restart of the <i>monitor</i>&nbsp;instances. That'll handle the odd case of <i>monitor</i>&nbsp;hanging.</div>