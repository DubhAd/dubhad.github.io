---
layout: post
title: Presence detection updated
date: '2018-09-06T21:00:00.000+01:00'
author: Tinkerer
tags:
modified_time: '2018-09-07T10:00:50.120+01:00'
---

A while back I covered how I <a href="https://blog.ceard.tech/2018/01/home-assistant-and-basic-presence.html">was doing presence detection</a>, and thought that since I've changed a few things I should update.<br /><h3>Little Big Changes</h3><div>I've ditched groups for tracking. There's a simple reason for this - the group is a blunt instrument. I still use them indirectly, and I'll explain how below. When I say blunt instrument, I mean that if any device tracker reports me as home, I'm home. Which is fine, until one misbehaves. Then I flip flop between home and away as each group member updates.</div><h3>Bayesian</h3><div>This is nice because I can weight individual things that indicate whether we may be home.</div><div><pre>- platform: 'bayesian'<br />  prior: 0.6<br />  name: 'person2 Home'<br />  probability_threshold: 0.95<br />  observations:<br />    - entity_id: 'device_tracker.person2_mobile'<br />      prob_given_true: 0.9<br />      platform: 'state'<br />      to_state: 'home'<br />    - entity_id: 'device_tracker.person2_mobile_bt'<br />      prob_given_true: 0.9<br />      platform: 'state'<br />      to_state: 'home'<br />    - entity_id: 'device_tracker.person2_mobile_gps'<br />      prob_given_true: 0.8<br />      platform: 'state'<br />      to_state: 'home'</pre></div><div>Basically, it requires that at least two out of the three trackers (WiFi, Bluetooth, GPS) report me as home, before I'm home. Initial testing is looking positive.<br /><br />Why am I weighting the GPS down a bit? Well, it doesn't change things here, but I've found it less reliable in terms of home/away. This is just my way of noting that.<br /><h3>Automation</h3></div><div>Until I'm comfortable that's working as intended, I'm using the following automation:</div><div><pre>- initial_state: 'on'<br />  alias: 'person2 home'<br />  trigger:<br />    - platform: state<br />      entity_id: <br />      - device_tracker.person2_mobile<br />      - device_tracker.person2_mobile_bt<br />      - device_tracker.person2_mobile_gps<br />      to: 'home'<br />    - platform: homeassistant<br />      event: start<br />  condition:<br />    - condition: numeric_state<br />      entity_id: group.person_person2<br />      above: 1<br />      value_template: "{{ "{{" }} dict((states|selectattr('entity_id', 'in', state_attr('group.person_person2', 'entity_id'))|list)|groupby('state'))['home']|count }}"<br />  action:<br />    - service: input_boolean.turn_on<br />      entity_id: input_boolean.person2_home</pre></div><div>This triggers when any of the individual trackers comes home, and then checks to see if at least two members of the group are home. Then if they are turns on an input boolean. Obviously there's a matching away automation that turns it off.<br /><h3>Going forwards</h3></div><div>I'll be comparing the results of these over the next few weeks. In theory I should find a perfect match, at which point I can switch to using the bayesian sensor.</div>