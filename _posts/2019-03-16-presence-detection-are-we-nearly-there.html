---
layout: post
title: Presence detection - are we nearly there yet?
date: '2019-03-16T16:32:00.000Z'
author: Tinkerer
tags:
- home assistant
- presence detection
modified_time: '2019-03-16T16:32:28.657Z'
---

Yes, yet another update. This is what comes from trying to refine things.<br /><h3>Bluetooth, bluetooth, everywhere</h3><div>My Home Assistant system sits in the far corner of the house from the front door. As a result the Bluetooth tracker is a bit hit and miss for entry. There's also a challenge that I've been finding that the Bluetooth devices seem to flip between home and away.</div><div><br /></div><div>I'd already been pointed towards <a href="https://github.com/andrewjfreyer/monitor">monitor</a> by others, so I sat down and read the rather long <a href="https://community.home-assistant.io/t/monitor-reliable-multi-user-distributed-bt-occupancy-presence-detection/68505">thread on the forum</a>. The only downside would be that I'd need to set up MQTT again, which took all of a couple of minutes.</div><h3>Trying it out</h3><div>I installed monitor on one of the other Pi's, and tested it out. After a few false starts, both with the config for monitor and the config for HA, I got it working as I wanted and proceeded to deploy it.</div><h4>Behaviour preferences</h4><div>The key changes for me here were increasing the arrival scans, dropping the minimum time between scans, setting an arrival filter, dropping the RSSI level to -95 (I'll explain that in the beacon section), and enabling the device tracker topic</div><div><div><pre>#MAX RETRY ATTEMPTS FOR ARRIVAL<br />PREF_ARRIVAL_SCAN_ATTEMPTS=2<br /><br />#MAX RETRY ATTEMPTS FOR DEPART<br />PREF_DEPART_SCAN_ATTEMPTS=2<br /><br />#SECONDS UNTIL A BEACON IS CONSIDERED EXPIRED<br />PREF_BEACON_EXPIRATION=240<br /><br />#MINIMUM TIME BEWTEEN THE SAME TYPE OF SCAN (ARRIVE SCAN, DEPART SCAN)<br />PREF_MINIMUM_TIME_BETWEEN_SCANS=15<br /><br />#ARRIVE TRIGGER FILTER(S)<br />PREF_PASS_FILTER_ADV_FLAGS_ARRIVE=".*"<br />PREF_PASS_FILTER_MANUFACTURER_ARRIVE="Google|HTC Corporation|LG Electronics|Chipolo"<br /><br />PREF_FAIL_FILTER_ADV_FLAGS_ARRIVE="NONE"<br />PREF_FAIL_FILTER_MANUFACTURER_ARRIVE="NONE"<br /><br />PREF_RSSI_IGNORE_BELOW=-95<br />PREF_DEVICE_TRACKER_REPORT=true<br /></pre></div><h4>MQTT preferences</h4><div>Here I've set the identity to be the location of the scanner, in this case they are <kbd>first floor front</kbd> and <kbd>first floor rear</kbd>.</div><h4>Static addresses</h4><div>A list of all the devices I want tracked</div><h4>Beacon addresses</h4><div>I bought a Chipolo classic beacon to track the presence of the car. Initially I was rather disappointed - I could trigger a beacon event by pushing the button, but then silence. However, having added it to their app, and then removing it, it beacons as expected.<br /><br />The only downside is that in the garage the signal level is below the default RSSI threshold of -75. Watching the log I could see it normally floated around -80 to -90, so set it to -95.<br /><h4>Aliases</h4></div><div>This ensures that the MQTT topics are human friendly.</div><h4>Command line flags</h4><div>I'm using <kbd>-x -b -tdr</kbd> as the flags, and these mean:<br /><ul><li>-x -&nbsp;retain mqtt status messages</li><li>-b - report bluetooth beacons</li><li>-tdr - only performs a <i>departure</i>&nbsp;scan when a message is published to the MQTT topic, and notifies other instances when it does a scan</li></ul><h3>How I'm using monitor</h3><div>I've got two Pi Zeros set up, one upstairs at the front of the house, and one upstairs at the back of the house. These conduct arrival scans automatically, or when triggered by the front door opening. Their positioning provides complete coverage through the entire house.</div><div><br /></div><div>Exit scans are run when the front door closes. And yes, scan<i style="font-weight: bold;">s</i>&nbsp;- it waits half a minute, runs a scan. That's just long enough that if we closed and walked away, we'll be out of range. It then runs further scans at one minute, two minutes, and four minutes. This, should, cover it when we leave but stop for a brief chat. I'll probably add another automation that is triggered when we're over 100 meters away, the WiFi tracker shows us away, and yet monitor thinks we're home. That should take care of when we end up chatting with the neighbours for some time.</div><div><br /></div><div>With the two systems, things have proven totally reliable. I've had no false away, and so far no missed departures either. This means that I've been able to turn off the Bluetooth trackers built into Home Assistant.</div><h3>Unexpected benefits</h3><div>There's been one unexpected benefit - my Home Assistant system starts faster. Disabling the Bluetooth trackers has cut five minutes off the startup time, which accounted for most of the startup time.</div><h3>Changes to presence tracking</h3><div>I know I've said <i>don't use groups</i>, but I'm using groups again. All I'm putting in those groups though are the WiFi and Bluetooth trackers. I'm not using the GPS device tracker at all for home/away logic. This makes the groups safe here. Everything that follows is, of course, on <a href="https://github.com/DubhAd/Home-AssistantConfig">my GitHub</a>.</div><h3>Home</h3><div>There is now an automation, and a script, for each person.</div><div><br /></div><div><b>Automation</b></div><div><pre>initial_state: 'on'<br />alias: 'person1 home'<br />trigger:<br />  - platform: state<br />    entity_id:<br />    - group.person_person1<br />    to: 'home'<br />  - platform: homeassistant<br />    event: start<br />condition:<br />  - condition: state<br />    entity_id: input_boolean.person1_home<br />    state: 'off'<br />  - condition: state<br />    entity_id: group.person_person1<br />    state: 'home'<br />action:<br />  - service: script.person1_home<br /></pre></div><div><b>Script</b></div><div><pre>alias: person1 home<br />sequence:<br />  - service: input_boolean.turn_off<br />    entity_id: input_boolean.person1_travelling<br />  - service: input_boolean.turn_on<br />    entity_id: input_boolean.person1_home<br />  - service: mqtt.publish<br />    data:<br />      topic: location/person1<br />      payload: 'home'<br />  - service: automation.turn_on<br />    entity_id: automation.person1_at_work<br />  - service: script.person1_traveltime<br /></pre></div><div>That MQTT publish is for the new <a href="https://www.home-assistant.io/components/person">person component</a>. Right now the logic of that component is purely that the most recent update wins, which is a step backwards. So I cheat.<br /><br />The last script updates the Google and Waze travel time sensors. Those are both configured to update only a few times a day, and I update on demand from automations. The result is that on a typical day I'm using less than 10% of the daily quota, rather than hitting the quota limit before the day is over.<br /><h3>Away</h3><div><b>Automation</b><br /><pre>alias: 'person1 away'<br />initial_state: 'on'<br />trigger:<br />  - platform: state<br />    entity_id:<br />    - group.person_person1<br />    to: 'not_home'<br />  - platform: homeassistant<br />    event: start<br />condition:<br />  - condition: state<br />    entity_id: input_boolean.person1_home<br />    state: 'on'<br />  # Both BT and WiFi are away<br />  - condition: state<br />    entity_id: group.person_person1<br />    state: 'not_home'<br />action:<br />  - service: script.person1_away<br /></pre>Now that's much simpler than before. Before I had to track if the front door had been opened recently. With monitor only scanning for departure if a door opens, that's handled externally.<br /><br /><b>Script</b><br /><pre>alias: person1 away<br />sequence:<br />  - service: input_boolean.turn_off<br />    entity_id: input_boolean.person1_home<br />  - service: mqtt.publish<br />    data:<br />      topic: location/person1<br />      payload: 'not_home'<br /></pre>Again, updating the fake device tracker to keep the person component happy.<br /><h3>What's next?</h3></div></div></div></div><div>I don't <i>think</i>&nbsp;there's a lot more to do now to the logic. I can probably drop the use of the input boolean and start using the person component, but I'll wait to see how that component shapes out first.</div><div><br /></div><div>I may also deploy another Pi Zero W in or above the garage, to improve coverage there.</div>