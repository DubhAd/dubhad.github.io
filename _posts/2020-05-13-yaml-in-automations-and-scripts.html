---
layout: post
title: YAML in automations and scripts
date: '2020-05-13T16:46:00.000+01:00'
author: Tinkerer
tags:
- yaml
- home assistant core
- automation
- home assistant
modified_time: '2020-05-13T16:46:01.614+01:00'
---

I see many people struggle with the formatting for automations (and scripts) because the official docs are structured in a manner that assumes you're going to read them in order. So, I thought I'd pull together a little primer. If you're a YAML purist you probably want to look away now, I'm aiming to make this accessible not 100% technically correct.<div><h1 style="text-align: left;">YAML (very) basics</h1><div>YAML largely consists of two things, dictionaries and lists. Dictionaries are the really important piece here, because they hold everything (ultimately). For example:</div><pre style="text-align: left;">homeassistant:</pre><div>Yup, that's a dictionary. In this case it's empty, but it's a dictionary. Dictionaries can hold other dictionaries, or lists. What's a list? Here's a list example from <a href="https://www.home-assistant.io/docs/configuration/basic/" target="_blank">the documentation</a>:</div><div><pre style="text-align: left;">whitelist_external_dirs:<br />&nbsp; - /usr/var/dumping-ground<br />&nbsp; - /tmp</pre></div><div>That's a list, with two entries (values). Each entry is marked by the hyphen (-).</div><div><br /></div><div>You can also separate list items with commas, like this, but I find that it's often less readable:</div><div><pre style="text-align: left;">whitelist_external_dirs: [ /usr/var/dumping-ground, /tmp ]</pre></div><div>The question that always comes up is when you use a dictionary and when you use a list. The unfortunate answer is that you have to check the documentation. Even more unfortunately, a single entry list doesn't <i>need</i>&nbsp;that - so you'll sometimes see a list written like:</div><div><pre>whitelist_external_dirs:<br />&nbsp; /usr/var/dumping-ground</pre></div><div>That is perfectly valid, but you can see why it causes confusion.</div><div><br /></div><div>Here's a little more from that page:</div><div><pre style="text-align: left;">homeassistant:<br />&nbsp; latitude: 32.87336<br />&nbsp; longitude: 117.22743<br />&nbsp; whitelist_external_dirs:<br />&nbsp; &nbsp; - /usr/var/dumping-ground<br />&nbsp; &nbsp; - /tmp</pre></div><div>That's a dictionary (<kbd>homeassistant</kbd>) holding:</div><div><ul style="text-align: left;"><li>Two dictionaries (<kbd>latitude</kbd> and <kbd>longitude</kbd>)</li><li>One list (<kbd>whitelist_external_dirs</kbd>)</li></ul></div><div>These are the basic building blocks. If you want more on the subject see <a href="http://thomasloven.com/blog/2018/08/YAML-For-Nonprogrammers/" target="_blank">this blog post</a>.</div><h2 style="text-align: left;">Spaces</h2><div>With YAML, spaces (indenting) are critical. You need to keep your indenting consistent (the advice is generally to use <i>two spaces</i>&nbsp;per level. Oh, and don't use tabs, unless your editor converts them to spaces. Tabs cause Home Assistant to spit out errors too. Here's an example with broken indenting that I've seen people try to use:</div><div><pre style="text-align: left;">automation:<br />&nbsp; - alias: "My test automation"<br /><i>&nbsp; &nbsp; &nbsp; id: "unique_value_42"<br />&nbsp; &nbsp; &nbsp; initial_state: "on"<br /></i>&nbsp; &nbsp; trigger:<br />&nbsp; &nbsp; &nbsp; - platform: state<br />&nbsp; &nbsp; &nbsp; &nbsp; entity_id:&nbsp;<br /><i>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; - switch.furnace<br /></i>&nbsp; &nbsp; &nbsp;   &nbsp; - switch.extractor</pre></div><div>Here is how it should look:</div><div><pre style="text-align: left;">automation:<br />&nbsp; - alias: "My test automation"<br />&nbsp; &nbsp; id: "unique_value_42"<br />&nbsp; &nbsp; initial_state: "on"<br />&nbsp; &nbsp; trigger:<br />&nbsp; &nbsp; &nbsp; - platform: state<br />&nbsp; &nbsp; &nbsp; &nbsp; entity_id:&nbsp;<br />&nbsp; &nbsp;   &nbsp; &nbsp; - switch.furnace<br />&nbsp; &nbsp; &nbsp;   &nbsp; - switch.extractor</pre></div><div>Running a configuration check will warn you when the YAML is invalid, and it's something you should do any time you write any YAML.&nbsp;</div><h2 style="text-align: left;">Quoting</h2><div>You don't <i>have</i>&nbsp;to quote things in YAML, but for strings (text) you should or the result may be unexpected. What do I mean? Well <kbd>"On"</kbd> is a string, but <kbd>On</kbd> is a boolean value. These things to humans look the same, but to the computer they're different. Similarly if you have a number, like <kbd>42</kbd>, that's a number, but if you put it in quotes, like <kbd>"42"</kbd>, then that's a string.&nbsp;</div><div><br /></div><div>When you need to use multiple quotes on a line, then you need to use different ones for the outer quotes than the inner quotes, like:</div><pre style="text-align: left;">automation:<br />&nbsp; - alias: "Tom's alarm is ringing"</pre><div>This becomes particularly important if you're using templates.</div><h2 style="text-align: left;">Case sensitivity</h2><div>You also need to keep in mind that computers don't treat capital letters the same as lower case letters. The string <kbd>"home"</kbd> is different to the computer from <kbd>"Home"</kbd>, so you need to be sure which it is you're looking for.</div><h2 style="text-align: left;">States</h2><div>The state you see in Home Assistant's user interface may not be the actual state. You need to look at the entity in <i>Developer Tools</i>&nbsp;and then <i>States</i>&nbsp;to see the actual state of the entity. For example, a door/window sensor will show as <i>Open </i>or <i>Closed </i>in the user interface, but is actually <kbd>'on'</kbd> and <kbd>'off'</kbd>.</div><h1 style="text-align: left;"><a id="automation-structure">Automation Structure</a></h1><div>An automation has four parts</div><div><ol style="text-align: left;"><li>Information about the automation</li><li>Trigger</li><li>Condition (optional)</li><li>Action</li></ol><h2 style="text-align: left;">About the automation</h2></div><div>There are up to three things you'll have here.&nbsp;</div><div><ol style="text-align: left;"><li>The first is the <kbd>alias</kbd>, the human readable name. This will typically be used to form the <kbd>entity_id</kbd> of the automation.</li><li>Optionally there's an <kbd>id</kbd>. This is used by the automation editor and if present is used to form the <kbd>entity_id</kbd> (instead of the <kbd>alias</kbd>).</li><li>Finally there's an optional <kbd>initial_state</kbd>. This is used to force the automation to be enabled or disabled at startup.</li></ol><div><pre style="text-align: left;">automation:<br />&nbsp; - alias: "My test automation"<br />&nbsp; &nbsp; id: "unique_value_42"<br />&nbsp; &nbsp; initial_state: "on"</pre></div><div>The automation is a list entry, in the automation dictionary.</div><h2 style="text-align: left;">Trigger</h2></div></div><div>This is the bit that kicks it all off, your list of triggers. When <i>any</i>&nbsp;trigger statement <i>becomes true</i> then the processing begins. You have to have at least one trigger, and you can have as many as you need. It's worth taking the time now to <a href="https://www.home-assistant.io/docs/automation/trigger/" target="_blank">read the triggers page</a>, and see what's possible (and what causes a trigger to become true). Here's a simple one:</div><div><pre style="text-align: left;">&nbsp; &nbsp; trigger:<br />&nbsp; &nbsp; &nbsp; - platform: state<br />&nbsp; &nbsp; &nbsp; &nbsp; entity_id:&nbsp;<span style="background-color: #fdfdfd; font-family: consolas, monaco, &quot;andale mono&quot;, &quot;ubuntu mono&quot;, monospace; font-size: 13.005px; white-space: pre-wrap;">device_tracker.tinkerer<br /></span>&nbsp; &nbsp; &nbsp; &nbsp; to: 'home'</pre></div><div>I've used the list indicator here, even though I only have one trigger. This is to make it clearer that triggers are a list. This will trigger when <kbd>device_tracker.tinkerer</kbd> becomes <kbd>'home'</kbd>. Here is a more complex one:</div><div><pre style="text-align: left;">&nbsp; &nbsp; trigger:<br />&nbsp; &nbsp; &nbsp; - platform: state<br />&nbsp; &nbsp; &nbsp; &nbsp; entity_id: device_tracker.tinkerer<br />&nbsp; &nbsp; &nbsp; &nbsp; to: 'home'<br />&nbsp; &nbsp; &nbsp; - platform: state<br />&nbsp; &nbsp; &nbsp; &nbsp; entity_id: device_tracker.<span style="white-space: normal;">better_half</span><br />&nbsp; &nbsp; &nbsp; &nbsp; to: 'home'</pre></div><div>Two triggers - here the automation will start processing if either <kbd>device_tracker.tinkerer</kbd> or <kbd>device_tracker.better_half</kbd> become <kbd>'home'</kbd>. Since both are looking for the same target state, I could have written the more compact version:&nbsp;</div><div><div><pre style="text-align: left;">&nbsp; &nbsp; trigger:<br />&nbsp; &nbsp; &nbsp; - platform: state<br />&nbsp; &nbsp; &nbsp; &nbsp; entity_id:&nbsp;<br />          - device_tracker.tinkerer<br />          - device_tracker.<span style="white-space: normal;">better_half</span><br />&nbsp; &nbsp; &nbsp; &nbsp; to: 'home'</pre></div></div><div>I prefer this, partly because it's more compact, but also because it's much easier to read.</div><h2 style="text-align: left;">Conditions</h2><div>Conditions are optional - you don't need any if your automation doesn't call for one.</div><div><br /></div><div>All the conditions in the list have to be <i>currently&nbsp;</i>true for the automation to run. There are <a href="https://www.home-assistant.io/docs/scripts/conditions/" target="_blank">many available conditions</a>, including some that allow you to say that <i>this or that</i>&nbsp;must be true. Conditions are particularly useful when you have multiple triggers, and want them all to be true for the automation to run. With conditions however you have to list each separately, you can't combine them like we did for triggers:</div><div><pre style="text-align: left;">&nbsp; &nbsp; condition:<br />&nbsp; &nbsp; &nbsp; - condition: state<br />&nbsp; &nbsp; &nbsp; &nbsp; entity_id: device_tracker.tinkerer<br />&nbsp; &nbsp; &nbsp; &nbsp; state: 'home'<br />&nbsp; &nbsp; &nbsp; - condition: state<br />&nbsp; &nbsp; &nbsp; &nbsp; entity_id: device_tracker.better_half<br />&nbsp; &nbsp; &nbsp; &nbsp; state: 'home'</pre></div><div>Here we require that both device trackers are <i>currently</i> in the state&nbsp;<span style="font-family: monospace;">'home'</span>. If the automation is triggered by me arriving home, while the wife is still away, then one condition will be false, and the automation won't run.</div><h2 style="text-align: left;">Actions</h2><div>This is where things happen. Actions are <a href="https://www.home-assistant.io/docs/scripts/" target="_blank">basically scripts</a>&nbsp;- a list of actions to take in sequence. That means you can call services (do things), check conditions, pause for a fixed time (<kbd>delay</kbd>) or until a <a href="https://www.home-assistant.io/docs/configuration/templating/" target="_blank">template</a> becomes true (<kbd>wait_template</kbd>), or send events. You have at least one, and potentially <i>many</i> actions. If any step fails (or returns false) then the automation stops at that point. This is handy for condition checks, and not so handy at other times.</div><div><br /></div><div>With a service call you can generally give one, or many, entities, for example:</div><div><pre style="text-align: left;">    action:<br />      - service: switch.turn_on<br />        entity_id: <br />          - switch.furnace<br />          - switch.extractor<br />      - condition: state<br />        entity_id: sun.sun<br />        state: 'below_horizon'<br />      - service: light.turn_on<br />        data:<br />          entity_id: light.basement, light.stairwell</pre></div><div>Here I've shown the two different ways of listing multiple entities - I prefer the first method. You'll see that one of these has a <kbd>data</kbd> block, and one doesn't. Generally speaking, you need a <kbd>data</kbd> block where you're providing more than just an <kbd>entity_id</kbd>, but it's best to simply follow what's in the documentation.</div><div><br /></div><div>This particular action block will turn on two switches, and then only if the state of <kbd>sun.sun</kbd> is <kbd>'below_horizon'</kbd> will it turn on the two lights.</div>